title=Rendering massive amounts of animated grass
date=2020-09-27
type=post
tags=foliage rendering,vegetation rendering,opengl,grass rendering,pivot based animation
status=published
headline=How to render a shit ton of (animated) grass in real time
subheadline=As if it was easy!
summary=Foilage is as needed in games as it is costly to render in large amounts. How smart culling and low driver overhead can help rendering massive amounts of grass blades.
image=images/640px-Green_Grass.jfif
~~~~~~
<p>&nbsp;I recently played Ghost of Tsushima and I was impressed by the amount of foilage that covers the world. Just as I was impressed when I played Horizon: Zero Dawn a few years back.</p><p>So my engine can already render a lot of instanced geometry, a lot of per-instance animations and so on, but for <b>that</b>&nbsp;much foilage that is needed for believable vegetation, this is too costly. The answer to the problem is pivot based animation and therefore some simple, stateless animation in the vertex shader.</p><p>In addition to that, the instances of for example grass, need to be clustered and culled efficiently. My two-phase occlusion and frustum culling pipeline is exhausted pretty fast, when we use it for 10000000 small instances without any hierarchical component. A cluster is best and easy a small local volume that covers enough instances to not mitigate the benefit of batching. For example it's not worth batching only 10 instances, only to be able to cull them better. 1000 instances seem to work well for me. I generate a cluster's instances randomly, so that I can just render the first n instances and scale n by distance between camera and cluster. This way, the cluster gets thinner and thinner, until completely culled. Hard culling results in pop-ins. For a smooth fadeout without alpha blending enabled - which would again kill the performance of foliage - screen door transparency can be used. This is again a simple few lines, now in the pixel shader, and culling is mostly hidden.</p><p>Three things that are for themselves very efficient team up for a nice solution for foliage: Pivot based animation, cluster culling and screen door transparency fading.</p><div class="separator" style="clear: both; text-align: center;"><iframe allowfullscreen="" class="BLOG_video_class" height="334" src="https://www.youtube.com/embed/vfwO2LeOqyA" width="402" youtube-src-id="vfwO2LeOqyA"></iframe></div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><iframe allowfullscreen="" class="BLOG_video_class" height="335" src="https://www.youtube.com/embed/s3dUbjYogHU" width="403" youtube-src-id="s3dUbjYogHU"></iframe></div><div><br /></div>As stated under the first video, I don't have nicely authored pivot textures, so I created a veeeeery simple one that just goes from 0-1 from root to leaves of the grass.<br /><div><br /></div><p><br /></p>